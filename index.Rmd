---
title: "Advertisements Key Insights"
author: "Ondrej Pekacek/TI CZ"
date: "Last updated `r format (Sys.time(),'%d. %m. %Y')`"
output: 
  flexdashboard::flex_dashboard:
    logo: "data/logo_ti.png"
    theme: cosmo
    orientation: columns
    vertical_layout: fill
    source_code: https://github.com/opop999/election_monitoring_fb_ads
    navbar:
      - {title: "About", icon: "ion-information-circled", href: "https://www.transparentnivolby.cz/snemovna2021"}
---

```{r setup, include=FALSE}
# Disable scientific notation of numbers
options(scipen = 999)

# Package names
packages <- c("flexdashboard", "dplyr", "ggplot2", "plotly", "forcats", "htmlwidgets")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# Packages loading
invisible(lapply(packages, library, character.only = TRUE))

summary_dataset <- readRDS(file = "data/summary_tables/merged_summary.rds")
time_dataset <- readRDS(file = "data/summary_tables/time_summary.rds")

# Specify output directory for individual html plots (to be embedded to website)
directory <- "data/html_plots"

# Check whether output directory exists to save individual plots
if (!dir.exists(directory)) {
  dir.create(directory)
} else {
  print("Output directory already exists")
}

```

Total Ads
=====================================

Column
-----------------------------------------------------------------------

### Total Ads

```{r}
plot_total_ads <- ggplotly(summary_dataset %>%
  filter(total_ads > 10) %>%
  ggplot(aes(x = total_ads, y = reorder(page_name, total_ads), fill = percent_unique)) +
  geom_col() +
  scale_fill_gradient(
    low = "#fbe8e7", high = "#db1d0b",
    limits = c(0, 1),
    breaks = c(0, 0.25, 0.50, 0.75, 1),
    labels = c("0%", "25%", "50%", "75%", "100%")
  ) +
  scale_x_continuous(
    breaks = seq(0, 2500, 250),
    labels = seq(0, 2500, 250)
  ) +
  theme_minimal() +
  xlab("Total Ads") +
  ylab(element_blank()) +
  labs(fill = "Proportion unique ads") +
  ggtitle("Ads since 1.1.2021 of pages with more than 10 ads"))

plot_total_ads

htmlwidgets::saveWidget(plot_total_ads, file = paste0(directory, "/plot_total_ads.html"))

```

Total Spending
=====================================

Column 
-----------------------------------------------------------------------

### Total Spending

```{r}
plot_total_spending <- ggplotly(summary_dataset %>%
  filter(total_ads > 10) %>%
  mutate(
    avg_spend_1000 = round(avg_spend / 1000, digits = 0),
    per_ad_avg_spend_1000 = round(per_ad_avg_spend / 1000, digits = 1)
  ) %>%
  ggplot(aes(x = avg_spend_1000, y = reorder(page_name, avg_spend), fill = per_ad_avg_spend_1000)) +
  geom_col() +
  scale_fill_gradient(
    low = "#e6ecf2", high = "#03457f",
    limits = c(0, 10)
  ) +
  scale_x_continuous(breaks = seq(0, 3000, 250),
                    labels = seq(0, 3000, 250)) +
  xlab("Total Spend (CZK thousands)") +
  ylab(element_blank()) +
  labs(fill = "Per Ad (CZK thousands)") +
  ggtitle("Spending on ads since 1.1.2021"))

plot_total_spending

htmlwidgets::saveWidget(plot_total_spending, file = paste0(directory, "/plot_total_spending.html"))

```

Spending in Time
=====================================

Column 
-----------------------------------------------------------------------

### Spending in time

```{r}

# Select TOP 10 biggest spenders for plotting
top_10_spenders <- summary_dataset %>% 
  slice_max(avg_spend, n = 10) %>% 
  select(page_name, page_id, avg_spend)

# Set the election date as a positon of a red vertical line in the plot
election_date <- as.Date("2021-10-08")

spend_over_time <- ggplotly(
    time_dataset %>%
    filter(page_id %in% top_10_spenders$page_id) %>% 
    mutate(cumulative_spend_milion = round((cumulative_spend / 1000000), digits = 3)) %>% 
    ggplot(aes(x = ad_creation_time, y = cumulative_spend_milion, color = page_name)) +
    geom_line() +
    geom_vline(aes(xintercept = as.numeric(election_date)), color = "#db1d0b") +
    geom_text(aes(x = election_date, y = 0, label = "elections"), color = "#03457f", size = 4, angle = 90, vjust = -0.4, hjust = 0) +
    theme_minimal() +
    scale_y_continuous(
      breaks = seq(0, 5, 0.5),
      labels = seq(0, 5, 0.5)
    ) +
    scale_x_date(date_breaks = "1 months", date_labels = "%m") +
    coord_cartesian(xlim = c(as.Date("2021-01-01"), as.Date("2021-11-26"))) +
    theme(legend.title = element_blank()) +
    xlab(element_blank()) +
    ylab(element_blank()) +
    ggtitle("Spending (in millions CZK) on FB Ads, January 2021-present")
)

spend_over_time

htmlwidgets::saveWidget(spend_over_time, file = paste0(directory, "/spend_over_time.html"))


```

